
## 12. 시스템 메모리 부족 파악 (top 표시 전환)

- load average는 큰데 CPU 사용률이 높은 프로세스가 없는 경우 메모리 부족이 원인일 수 있다
- load average는 CPU 처리를 기다리는 작업 개수
- CPU 부하가 낮아도 load average가 높을 때가 있다
- load average가 높다는 것은 CPU 부하량에 비례하지 않는다


- CPU가 하는 작업 중에 부하가 높지 않아도 처리 완료까지 엄청나게 시간이 걸리는 것이 있다 
- 대표적인 예가 디스크 I/O
- CPU는 계산 처리는 빠르게 할 수 있지만 하드디스크에 저장한 파일을 찾거나 내용을 읽거나 파일을 저장할 때는 끝날 때 까지 기다려야 하기 때문에 오랜 시간이 걸린다


- CPU는 보통 작업 장소로 메인 메모리를 사용하지만 메모리 여유 공간이 부족하면 새로운 작업을 할 수 없다
- 이때 OS는 메모리에최근에 상요하지 않는 데이터를 정리해서 메모리에 빈 공간을 만들어 낸다 
- 정리된 데이터는 일단 하드디스크에 옮기는데 이를 스왑 아웃 이라고 한다 
- 반대로 스왑 아웃한 데이터가 필요해지면 하드디스크에서 메모미로 데이터를 되돌리는데 이를 스왑 인 이라고 한다 
- 양쪽을 포함해서 스왑이라고 한다 


- 스왑은 OS가 알아서 관리하니까 각각의 프로그램은 메모리 상태를 신경 쓰지 않아도 된다
- 하지만 점점 더 메모리를 사용하면 스왑이 빈번히 발생해서 I/O 대기 시간이 무척 길어진다
- 이것이 메모리 부족 때문에 load average가 증가하는 이유이다

```
$ top

# MEM에서 프로세스가 소비하는 메모리량을 볼 수 있다 
```

- 프로그램은 필요할 때만 프로세스를 실행해서 처리가 끝나면 종료하는 것과 컴퓨터를 사용하는 동안 계속 프로세스를 실행시켜야 하는 것이 있다
- 이를 상주형 프로세스라고 하고 서비스라고 부른다
- 서비스는 kill로 종료시키면 안된다
- 서비스는 명령줄에서 실행하는 것이 아니라 서비스 전용 실행, 종료 방법이 있다
- 이를 기동 스크립트라고 한다 

```
# 기동 스크립트 사용법 중 대표적인 2가지

# 1. service 명령어 
# sudo service "서비스명" "제어"
$ sudo service apache restart


# 2. init.d 명령어 
# sudo /etc/init.d/"서비스명" "제어"
$ sudo /etc/init.d/apache2 restart
```

- 메모리가 부족해지면 스왑 아웃이 발생해서 데이터를 하드디스크에 기록한다
- 하지만 이게 계속 될 경우 데이터를 저장할 하드디스크 쪽이 가득차게 되어서 OS가 멈추지 않도록 리눅스는 OS가 적당히 프로세스를 골라서 강제 종료 시킨다
- 이런 기능을 OOM Killer (Out of Memory Killer)라고 한다 
- 이 OOM Killer는 SSH 접속을 받는 서비스까지 종료시킬 수가 있다

- load average가 높아도 CPU는 과부하 상태가 아닐 수 있다
- 빈 메모리가 부족하면 -> 스왑(디스크 I/O)이 자주 발생 -> CPU 처리가 쌓임 -> load average가 높아져서 시스템 반응이 나빠짐
- 스왑량이 급격히 증가한다면 주의가 필요하다

```
$top

# SHIFT + M : 메모리 사용량 순서로 나열

# SHIFT + T : CPU 시간 순서로 나열

# SHIFT + P : CPU 사용량 순서로 나열
```

  
### Reference
  - [만화로 배우는 리눅스 시스템 관리](http://www.yes24.com/Product/Goods/32402055?Acode=101)
